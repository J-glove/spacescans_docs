
# The Preprocessing Pipeline

This document outlines the standards and processes used to format and preprocess exposome data. The goal is to translate raw exposome datasets—available at various geographic granularity—into standardized outputs (currently supporting 9-digit zip-code only). The following sections describe the preprocessing pipeline, command line usage, data formatting standards, buffer creation procedures, and precalculation module.

## Overview of the Preprocessing Pipeline

The preprocessing pipeline is designed to precompute values for every available exposome variable based on spatiotemporal identifiers and store them in a database. The architecture consists of three primary components:

1. Raw Data Formatting: 
   
    Converts raw exposome data downloaded from various websites into a standardized format. This process includes adding FIPS codes, temporal scales, and consistent headers.

2. Buffer Generation:

    Uses shape files and lattitude/longitude data to create geographic buffers. These buffers allow calculation of the percentage overlap between a given FIPS code and another geo-identifier. (e.g. 9-digit zip-code)

3. Precalculation Module:

    Maps the formatted exposome data (typically divided by FIPS code and time period) onto the desired geo-identifiers using the pre-generated buffers. Currently, this module supports 9-digit zip-code with plans to generalize to other geo-identifiers. The results are then inserted into a persistent database, which is queried during runtime for study specific linkages.

### Pipeline Diagram
Insert Diagram

## Exposomes Formatted
This section describes the standardized practices for formatting output files generated by the raw exposome preprocessing scripts. Consistency and clarity are key, especially in labeling time and geographic identifiers.

### Input Data Sources
Refer to the **AvailableExposomeVariableList_2023.xlsx** for a complete list of data sources. Below are the current data sources and some details.

- ACAG
    - [Website]()
    - Format: .nc
    - Years Available: 1998 - 2022

- CACES
    - [Website]()
    - Format: .csv

- EPA NATA/ AirToxScreen
    - [NATA Website]()
    - [AirToxScreen Website]()
    - Format: .csv
    - Years Available:
        - NATA: 1996, 1999, 2002, 2005, 2011, 2014
        - AirToxScreen: 2017 - 2019
    
- HUD
    - [Website]()
    - Format: .dbf
    - Years available:

- Walkability Index
    - [Website]()
    - Format: .csv
    - Includes only GEOID10 and NatWalkInd

- FARA
    - [Website]()
    - Format: .csv

- ACS/NDI
    - TBD

- CBP/ZBP
    - [Website]()
    - Format: .csv

- UCR
    - [Website]()
    - Denominator from ACS - ??? - Ask Chengrong about this

### Output File Specifications
The ouptut file is a comma separated file containing the translated exposome values with the same temporal resolution as source and 9-digit zip-code geoidentifier. The filename should be of the form `preprocessed_[data_source].csv`. The field names should be consistent amongst the datasources. Currently, all fields need to be in UPPERCASE. For 9-digit zip-code resolution, the geoidentifier field is always `ZIP9`
__Needs Work__


### Command Line Interface (CLI)
The preprocessing pipeline simplifies the translation of raw exposome data into 9-digit zip-code based data. The following describes how to run the pipeline: [__Need to add a breakdown of the input and output of this pipeline__]

1. Command Line Flags

    Run the following command (example using National Walkability Index):
    ```
    python run_preprocessing_pipeline.py \
            --data_list path/to/data_list \
            --output_dir /path/to/output \
            --buffer_dir /path/to/buffer_files \
            --exposome_type wi
    ```
    > Need to give a list of the different accepted values for exposome type

2. Configuration File

    The `./example` directory contains sample configurations. Update the `config.yaml` to include:
        - __data_list__: Path to your raw exposome data
        - __output_dir__: Directory where processed data will be saved
        - __buffer_dir__: Location of temporary buffer files
        - __exposome_type__: Type of exposome data to process

    > For best practice, use absolute paths when defining directories.

    To run:
    ```
    python run_preprocessing_pipeline.py --config /path/to/config.yaml
    ```

3. Overriding Config Parameters

    When running the pipeline from a config file, we can use the command line flags to override parts of the config. This allows us to use the same config multiple times for slightly different run options.
    For example, to change the data list directory:

    ```
    python run_preprocessing_pipeline.py --config ./example/config.yaml --data_list /path/to/new/directory
    ```


## Buffer Creation
Different exposomes use varying catographic boundary mappings. To align with these sources, we create buffer files that map 9-digit ZIP codes (used by the address history) to the geographic standards of the exposome data.

### Input Files
- __9-digit Zip-code Latitude/Longitude Data__:

    Derived from the OneFlorida+ database. This dataset provides 9-digit zip-code data with integrated longitudinal and latitudinal coordinates and is updated regularly.
    
    - __Example Columns__:

        - AREAKEY
        - CT
        - X (longitude)
        - Y (latitude)

- __Shape Files__:

    Include County, ZCTA, Census Tract, and Block Group shape files downloaded from the US Census site (currently TIGER2010).

### Output File Specifications
The output file from buffer generation is a .csv, with UPPERCASE column names and a prefix for zip-code columns (ZIP_5 or ZIP_9)

### Command Line Interface
TBD

## Precalculation Module 
The precalculation module uses the pre-generated buffer files to compute area-weighted averages for each exposome variable at the ZIP code level. This conversion is necessary because the raw exposome data is typically reported in other geographic formats (e.g., FIPS codes).

### Input Format
- __Formatted Exposome Data__:

    Processed data with standardized headers and geographic identifiers.

- __Buffer File__:

    Generated in the previous step, mapping the raw geographic units to zip-code

### Output File Specifications
The output is a .csv file with all column names in UPPERCASE, with a standardized geoidentifier and temporal naming convention regardless of datasource. (e.g. ZIP_9, YEAR, QUARTER)


### Command Line Interface
TBD

### Guidelines for Implementing Formatters
- __Consistency__:

    Ensure that all output files adhere strictly to the standards. Each file must have properly capitalized headers that accurately reflect the content.

- __Reference Documentation__:

    The output should conform to the Exposome SQLite Database Specification.

- __Verification__:

    Validate that all column headers are correct, and that the data aligns with the expected formats (e.g. geo-identifier and time units).

